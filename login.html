<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log in / Sign up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 520px; margin: 40px auto; padding: 0 16px; }
    input { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
    button { padding: 10px 14px; cursor: pointer; }
    .box { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .error { color:#b00020; margin-top: 8px; min-height: 18px; }
    .muted { color:#666; font-size:14px; }
    .hidden { display: none; }
    .mode { margin: 8px 0 2px; font-weight: 700; }
    .small { font-size: 12px; color: #666; margin: 0 0 8px; }
  </style>
</head>
<body>
  <h1>Log in / Sign up</h1>

  <div class="box">
    <div class="mode" id="modeTitle">Log in</div>
    <p class="small" id="modeHint">Enter your email and password to log in.</p>

    <input id="email" type="email" placeholder="Email" autocomplete="email" />
    <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
    <input id="pw2" class="hidden" type="password" placeholder="Confirm password" autocomplete="new-password" />

    <div class="row">
      <button id="btnLogin" type="button">Log in</button>
      <button id="btnSignup" type="button">Create account</button>
    </div>

    <p class="muted">You can build your CV for free. Export (PDF/HTML) requires purchase (30 days).</p>
    <p id="err" class="error"></p>
  </div>

  <script>
    // Endpoints/URLs
    const AUTH_URL = "/api/auth";
    const PAY_URL  = "https://payhip.com/b/AeoVP";
    const APP_URL  = "/index.html"; // <- editor/templaten din

    let mode = "login"; // "login" | "signup"

    function setMode(nextMode) {
      mode = nextMode;

      const pw2 = document.getElementById("pw2");
      const title = document.getElementById("modeTitle");
      const hint  = document.getElementById("modeHint");
      const pw1   = document.getElementById("pw");

      if (mode === "signup") {
        pw2.classList.remove("hidden");
        title.textContent = "Create account";
        hint.textContent = "Choose a password and confirm it.";
        pw1.setAttribute("autocomplete", "new-password");
      } else {
        pw2.classList.add("hidden");
        pw2.value = "";
        title.textContent = "Log in";
        hint.textContent = "Enter your email and password to log in.";
        pw1.setAttribute("autocomplete", "current-password");
      }
    }

    async function post(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    function setError(msg) {
      document.getElementById("err").textContent = msg || "";
    }

    function getPendingExportKind() {
      try { return localStorage.getItem("pending_export_kind") || ""; }
      catch { return ""; }
    }
    function clearPendingExportKind() {
      try { localStorage.removeItem("pending_export_kind"); } catch {}
    }

    // Hent "me" fra server for å se om bruker har betalt/export access
    async function fetchMe() {
      const { res, data } = await post(AUTH_URL, { action: "me" });
      if (!res.ok) return null;
      if (!data || data.ok !== true) return null;
      return data; // { email, has_access, templates, ... }
    }

    // ✅ Ny logikk:
    // - Hvis bruker kom hit fra Export (pending_export_kind finnes):
    //    - har_access => rett til editor/templaten (ingen Payhip)
    //    - ikke har_access => åpne Payhip + gå til editor
    // - ellers: rett til editor
    async function afterAuthNavigate() {
      const pending = getPendingExportKind();

      // Hvis ikke pending export: gå rett til editor/template
      if (!pending) {
        location.href = APP_URL;
        return;
      }

      // Pending export: sjekk access
      const me = await fetchMe();

      // Hvis me feiler, ikke send til buy (bedre UX) -> bare gå til app
      if (!me) {
        location.href = APP_URL;
        return;
      }

      if (me.has_access) {
        // ✅ Har betalt: ikke åpne Payhip
        clearPendingExportKind();
        location.href = APP_URL;
        return;
      }

      // ❌ Ikke betalt: åpne Payhip + gå til app
      window.open(PAY_URL, "_blank", "noopener,noreferrer");
      location.href = APP_URL;
    }

    async function doLogin() {
      setError("");
      setMode("login");

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pw").value;

      if (!email || !password) return setError("Email and password required");

      const { res, data } = await post(AUTH_URL, {
        action: "login",
        email,
        password
      });

      if (!res.ok) return setError(data.error || "Login failed");
      await afterAuthNavigate();
    }

    async function doSignup() {
      setError("");
      setMode("signup");

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pw").value;
      const passwordConfirm = document.getElementById("pw2").value;

      if (!email) return setError("Email required");
      if (!password || password.length < 8) return setError("Password must be at least 8 characters");
      if (!passwordConfirm) return setError("Please confirm your password");
      if (password !== passwordConfirm) return setError("Passwords do not match");

      const { res, data } = await post(AUTH_URL, {
        action: "signup",
        email,
        password,
        passwordConfirm
      });

      if (!res.ok) return setError(data.error || "Signup failed");
      await afterAuthNavigate();
    }

    // Klikk: første klikk bytter mode, andre klikk utfører handlingen
    document.getElementById("btnSignup").addEventListener("click", () => {
      if (mode !== "signup") {
        setMode("signup");
        setError("");
        return;
      }
      doSignup();
    });

    document.getElementById("btnLogin").addEventListener("click", () => {
      if (mode !== "login") {
        setMode("login");
        setError("");
        return;
      }
      doLogin();
    });

    // Enter: gjør riktig handling basert på mode
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      if (mode === "signup") doSignup();
      else doLogin();
    });

    setMode("login");
  </script>
</body>
</html>
